{"ast":null,"code":"import pusher from '../../../pusherConfig';\nimport * as actionTypes from '../actions';\nimport { store } from '../../../index';\nvar servers = null;\nvar channel = pusher.subscribe('presence-videocall');\nvar caller = new window.RTCPeerConnection(servers);\nvar userId = localStorage.getItem('userId');\nvar config = {};\n\ncaller.onicecandidate = function (evt) {\n  if (!evt.candidate) return; // alert('candidate')\n\n  onIceCandidate(caller, evt);\n};\n\ncaller.ontrack = function (evt) {\n  console.log(\"\".concat(userId, \" received remote stream\"));\n  store.dispatch(onTrack(evt));\n}; //setInterval(()=> console.log(caller.signalingState), 4000);\n\n\nchannel.bind(\"pusher:subscription_succeeded\", function (members) {//this.setState({id: this.props.channel.members.me.id, room: this.props.callTo});\n});\nchannel.bind(\"pusher:member_added\", function (member) {\n  console.log(member);\n});\nchannel.bind(\"pusher:member_removed\", function (member) {\n  if (member.id === config.room) {//   alert('call Ended');\n  }\n});\nchannel.bind(\"client-candidate\", function (msg) {\n  if (msg.room === config.room) {\n    var candidate = new RTCIceCandidate(msg.candidate);\n    console.log(candidate); //   addIceCandidate(candidate);\n\n    caller.addIceCandidate(candidate).then(function () {\n      return onAddIceCandidateSuccess(msg.room);\n    }, function (err) {\n      return onAddIceCandidateError(msg.room, err);\n    });\n    console.log(\"\".concat(msg.room, \" ICE candidate:\\n\").concat(msg.candidate ? msg.candidate.candidate : '(null)'));\n  }\n});\n\nfunction onAddIceCandidateSuccess() {\n  console.log(\"\".concat(userId, \" addIceCandidate success\"));\n}\n\nfunction onAddIceCandidateError(error) {\n  console.log(\"\".concat(userId, \" failed to add ICE Candidate: \").concat(error.toString()));\n}\n\nchannel.bind(\"client-sdp\", function (msg) {\n  if (msg.room === userId) {\n    store.dispatch({\n      type: actionTypes.ON_INCOMING_CALL,\n      callType: msg.callType,\n      caller: msg.from\n    });\n    config.room = msg.room;\n    config.sdp = msg.sdp;\n    config.state = 'answerCall';\n  }\n});\nchannel.bind(\"client-answer\", function (answer) {\n  if (answer.room === config.room) {\n    // let sessionDesc = new RTCSessionDescription(answer.sdp);\n    // setRemoteDescription(sessionDesc);\n    console.log('pc1 setRemoteDescription start');\n    caller.setRemoteDescription(answer.sdp).then(function () {\n      return onSetRemoteSuccess();\n    }, onSetSessionDescriptionError);\n  }\n});\nexport var callAccepted = function callAccepted() {\n  return function (dispatch) {\n    config.state = 'answerCall'; // let sessionDesc = new RTCSessionDescription(config.sdp);\n    // setRemoteDescription(sessionDesc);\n    // getCam();\n\n    console.log(\"\".concat(userId, \" setRemoteDescription start\"));\n    caller.setRemoteDescription(config.sdp).then(function () {\n      return onSetRemoteSuccess();\n    }, onSetSessionDescriptionError);\n    console.log(\"\".concat(userId, \" createAnswer start\")); // Since the 'remote' side has no media stream we need\n    // to pass in the right constraints in order for it to\n    // accept the incoming offer of audio and video.\n\n    caller.createAnswer().then(onCreateAnswerSuccess, onCreateSessionDescriptionError);\n    getMedia().then(gotStream).catch(function (e) {\n      return alert(\"getUserMedia() error: \".concat(e.name));\n    });\n    dispatch({\n      type: actionTypes.CALL_INIT\n    });\n    dispatch({\n      type: actionTypes.CALL_ACCEPTED\n    });\n  };\n};\n\nvar onCreateAnswerSuccess = function onCreateAnswerSuccess(desc) {\n  console.log(\"Answer from \".concat(userId, \":\\n\").concat(desc.sdp));\n  console.log(\"\".concat(userId, \" setLocalDescription start\"));\n  caller.setLocalDescription(desc).then(function () {\n    return onSetLocalSuccess();\n  }, onSetSessionDescriptionError);\n  channel.trigger(\"client-answer\", {\n    sdp: desc,\n    room: config.room\n  });\n};\n\nfunction onSetLocalSuccess() {\n  console.log(\"\".concat(userId, \" setLocalDescription complete\"));\n}\n\nfunction onSetRemoteSuccess() {\n  console.log(\"\".concat(userId, \" setRemoteDescription complete\"));\n}\n\nfunction onCreateSessionDescriptionError(error) {\n  console.log(\"Failed to create session description: \".concat(error.toString()));\n}\n\nfunction onSetSessionDescriptionError(error) {\n  console.log(\"Failed to set session description: \".concat(error.toString()));\n}\n\nexport var callRejected = function callRejected() {\n  return function (dispatch) {\n    channel.trigger(\"client-reject\", {\n      room: config.room,\n      rejected: userId\n    });\n    dispatch({\n      type: actionTypes.CALL_REJECTED\n    });\n  };\n};\n\nvar onLocalStream = function onLocalStream(stream) {\n  return {\n    type: actionTypes.ON_LOCAL_STREAM,\n    stream: stream\n  };\n}; //Create and send offer to remote peer on button click\n\n\nexport var callUser = function callUser(user, type) {\n  config.room = user;\n  config.callType = type;\n  config.state = 'makeCall';\n  config.initiator = true;\n  console.log('Requesting local stream');\n  return function (dispatch) {\n    // getCam();\n    getMedia().then(gotStream).catch(function (e) {\n      return alert(\"getUserMedia() error: \".concat(e.name));\n    });\n    dispatch({\n      type: actionTypes.CALL_INIT\n    });\n    var offerOptions = {\n      offerToReceiveVideo: true,\n      offerToReceiveAudio: true\n    };\n    caller.createOffer(offerOptions).then(onCreateOfferSuccess, onCreateSessionDescriptionError);\n  };\n};\n\nvar onCreateOfferSuccess = function onCreateOfferSuccess(desc) {\n  console.log(\"Offer from \".concat(userId, \"\\n\").concat(desc.sdp));\n  console.log(\"\".concat(userId, \" setLocalDescription start\"));\n  caller.setLocalDescription(desc).then(function () {\n    return onSetLocalSuccess();\n  }, onSetSessionDescriptionError);\n  channel.trigger(\"client-sdp\", {\n    sdp: desc,\n    room: config.room,\n    from: userId,\n    callType: config.callType\n  });\n};\n\nvar gotStream = function gotStream(stream) {\n  console.log('Received local stream');\n  store.dispatch(onLocalStream(stream));\n  stream.getTracks().forEach(function (track) {\n    caller.addTrack(track, stream);\n  });\n};\n\nvar getCam = function getCam() {\n  // alert('line 86--' + room);\n  getMedia().then(function (stream) {\n    store.dispatch(onLocalStream(stream));\n    stream.getTracks().forEach(function (track) {\n      caller.addTrack(track, stream);\n    });\n\n    if (config.state === 'makeCall') {\n      createOffer();\n    } else {\n      // let sessionDesc = new RTCSessionDescription(config.sdp);\n      // setRemoteDescription(sessionDesc);\n      createAnswer();\n      config.state = null;\n    }\n  }).catch(function (error) {\n    console.log(\"an error occured\", error);\n  });\n};\n\nvar getMedia = function getMedia() {\n  return navigator.mediaDevices.getUserMedia({\n    video: config.callType === 'video' ? {\n      width: 1280,\n      height: 720,\n      frameRate: 15\n    } : false,\n    audio: true\n  });\n};\n\nvar prepareCaller = function prepareCaller(channel) {\n  return {\n    type: actionTypes.PREPARE_CALLER,\n    channel: channel\n  };\n};\n\nexport var getCallerReady = function getCallerReady() {\n  return function (dispatch) {\n    dispatch(prepareCaller(channel)); //Listen for ICE Candidates and send them to remote peers\n    // caller.onicecandidate = evt => {\n    //   if (!evt.candidate) return;\n    //   alert('candidate')\n    //   onIceCandidate(caller, evt);\n    // };\n    // caller.onnegotiationneeded = async () => {\n    //     try {\n    //       await caller.setLocalDescription(await createOffer());\n    //       // send the offer to the other peer\n    //       channel.emit('', {desc: pc.localDescription});\n    //     } catch (err) {\n    //       console.error(err);\n    //     }\n    //   };\n    //ontrack handler to receive remote feed and show in remoteview video element\n    // caller.ontrack = evt => {\n    //     dispatch(onTrack(evt));\n    // };\n  };\n};\n\nvar onTrack = function onTrack(track) {\n  return {\n    type: actionTypes.ON_TRACK,\n    remoteStream: track.streams[0]\n  };\n};\n\nvar addIceCandidate = function addIceCandidate(iceCandidate) {\n  caller.addIceCandidate(iceCandidate);\n};\n\nvar onIceCandidate = function onIceCandidate(peer, evt) {\n  if (evt.candidate) {\n    channel.trigger(\"client-candidate\", {\n      candidate: evt.candidate,\n      room: config.room\n    });\n  }\n};\n\nvar setLocalDescription = function setLocalDescription(sessionDesc) {\n  return caller.setLocalDescription(sessionDesc);\n};\n\nvar setRemoteDescription = function setRemoteDescription(sessionDesc) {\n  return caller.setRemoteDescription(sessionDesc);\n};\n\nvar addTrack = function addTrack(track, stream) {\n  caller.addTrack(track, stream);\n};\n\nvar createAnswer = function createAnswer() {\n  // alert('createAnswer room: ' + receiver);\n  caller.createAnswer().then(function (sdp) {\n    var sessionDesc = new RTCSessionDescription(sdp);\n    setLocalDescription(sessionDesc);\n    channel.trigger(\"client-answer\", {\n      sdp: sdp,\n      room: config.room\n    });\n    console.log(caller.signalingState);\n  });\n  ;\n};\n\nvar createOffer = function createOffer() {\n  // alert('createOffer room--180: ' + room)    \n  caller.createOffer({\n    offerToReceiveVideo: true,\n    offerToReceiveAudio: true\n  }).then(function (desc) {\n    var sessionDesc = new RTCSessionDescription(desc);\n    setLocalDescription(sessionDesc); // console.log(config);\n    // alert('createOffer room--184: ' + config.room) \n\n    channel.trigger(\"client-sdp\", {\n      sdp: desc,\n      room: config.room,\n      from: userId,\n      callType: config.callType\n    });\n    console.log(caller.signalingState);\n  }).catch(function (err) {\n    return console.log(err);\n  });\n};\n\nexport var endCall = function endCall() {\n  return function (dispatch) {\n    dispatch({\n      type: actionTypes.END_CALL\n    });\n  };\n}; // setInterval(() => {\n//     console.log(caller.signalingState);\n// }, 3000);","map":{"version":3,"sources":["/Users/Gotzil/Desktop/React/PiperChat/piedpiper/client/src/store/actions/actionCreators/callActionCreators.js"],"names":["pusher","actionTypes","store","servers","channel","subscribe","caller","window","RTCPeerConnection","userId","localStorage","getItem","config","onicecandidate","evt","candidate","onIceCandidate","ontrack","console","log","dispatch","onTrack","bind","members","member","id","room","msg","RTCIceCandidate","addIceCandidate","then","onAddIceCandidateSuccess","err","onAddIceCandidateError","error","toString","type","ON_INCOMING_CALL","callType","from","sdp","state","answer","setRemoteDescription","onSetRemoteSuccess","onSetSessionDescriptionError","callAccepted","createAnswer","onCreateAnswerSuccess","onCreateSessionDescriptionError","getMedia","gotStream","catch","e","alert","name","CALL_INIT","CALL_ACCEPTED","desc","setLocalDescription","onSetLocalSuccess","trigger","callRejected","rejected","CALL_REJECTED","onLocalStream","stream","ON_LOCAL_STREAM","callUser","user","initiator","offerOptions","offerToReceiveVideo","offerToReceiveAudio","createOffer","onCreateOfferSuccess","getTracks","forEach","track","addTrack","getCam","navigator","mediaDevices","getUserMedia","video","width","height","frameRate","audio","prepareCaller","PREPARE_CALLER","getCallerReady","ON_TRACK","remoteStream","streams","iceCandidate","peer","sessionDesc","RTCSessionDescription","signalingState","endCall","END_CALL"],"mappings":"AAAA,OAAOA,MAAP,MAAmB,uBAAnB;AACA,OAAO,KAAKC,WAAZ,MAA6B,YAA7B;AACA,SAASC,KAAT,QAAuB,gBAAvB;AAEA,IAAMC,OAAO,GAAG,IAAhB;AACA,IAAMC,OAAO,GAAGJ,MAAM,CAACK,SAAP,CAAiB,oBAAjB,CAAhB;AACA,IAAMC,MAAM,GAAG,IAAIC,MAAM,CAACC,iBAAX,CAA6BL,OAA7B,CAAf;AACA,IAAMM,MAAM,GAAGC,YAAY,CAACC,OAAb,CAAqB,QAArB,CAAf;AAEA,IAAMC,MAAM,GAAG,EAAf;;AAEAN,MAAM,CAACO,cAAP,GAAwB,UAAAC,GAAG,EAAI;AAC3B,MAAI,CAACA,GAAG,CAACC,SAAT,EAAoB,OADO,CAE3B;;AACAC,EAAAA,cAAc,CAACV,MAAD,EAASQ,GAAT,CAAd;AACD,CAJH;;AAKER,MAAM,CAACW,OAAP,GAAiB,UAAAH,GAAG,EAAI;AACtBI,EAAAA,OAAO,CAACC,GAAR,WAAeV,MAAf;AACAP,EAAAA,KAAK,CAACkB,QAAN,CAAeC,OAAO,CAACP,GAAD,CAAtB;AACH,CAHC,C,CAKF;;;AACAV,OAAO,CAACkB,IAAR,CAAa,+BAAb,EAA8C,UAAAC,OAAO,EAAI,CAErD;AAED,CAJH;AAMAnB,OAAO,CAACkB,IAAR,CAAa,qBAAb,EAAoC,UAAAE,MAAM,EAAI;AAC1CN,EAAAA,OAAO,CAACC,GAAR,CAAYK,MAAZ;AACD,CAFH;AAIApB,OAAO,CAACkB,IAAR,CAAa,uBAAb,EAAsC,UAAAE,MAAM,EAAI;AAC5C,MAAIA,MAAM,CAACC,EAAP,KAAcb,MAAM,CAACc,IAAzB,EAA+B,CAC/B;AACC;AAEJ,CALD;AAMAtB,OAAO,CAACkB,IAAR,CAAa,kBAAb,EAAiC,UAAAK,GAAG,EAAI;AACpC,MAAIA,GAAG,CAACD,IAAJ,KAAad,MAAM,CAACc,IAAxB,EAA8B;AAC1B,QAAIX,SAAS,GAAG,IAAIa,eAAJ,CAAoBD,GAAG,CAACZ,SAAxB,CAAhB;AACAG,IAAAA,OAAO,CAACC,GAAR,CAAYJ,SAAZ,EAF0B,CAG9B;;AACET,IAAAA,MAAM,CAACuB,eAAP,CAAuBd,SAAvB,EACCe,IADD,CACM;AAAA,aAAMC,wBAAwB,CAACJ,GAAG,CAACD,IAAL,CAA9B;AAAA,KADN,EACgD,UAAAM,GAAG;AAAA,aAAIC,sBAAsB,CAACN,GAAG,CAACD,IAAL,EAAWM,GAAX,CAA1B;AAAA,KADnD;AAEFd,IAAAA,OAAO,CAACC,GAAR,WAAeQ,GAAG,CAACD,IAAnB,8BAA2CC,GAAG,CAACZ,SAAJ,GAAgBY,GAAG,CAACZ,SAAJ,CAAcA,SAA9B,GAA0C,QAArF;AACC;AACJ,CATD;;AAUA,SAASgB,wBAAT,GAAoC;AAChCb,EAAAA,OAAO,CAACC,GAAR,WAAeV,MAAf;AACD;;AAED,SAASwB,sBAAT,CAAgCC,KAAhC,EAAuC;AACrChB,EAAAA,OAAO,CAACC,GAAR,WAAeV,MAAf,2CAAsDyB,KAAK,CAACC,QAAN,EAAtD;AACD;;AACH/B,OAAO,CAACkB,IAAR,CAAa,YAAb,EAA2B,UAAAK,GAAG,EAAI;AAC9B,MAAIA,GAAG,CAACD,IAAJ,KAAajB,MAAjB,EAAyB;AACrBP,IAAAA,KAAK,CAACkB,QAAN,CAAe;AAACgB,MAAAA,IAAI,EAAEnC,WAAW,CAACoC,gBAAnB;AAAqCC,MAAAA,QAAQ,EAAEX,GAAG,CAACW,QAAnD;AAA6DhC,MAAAA,MAAM,EAAEqB,GAAG,CAACY;AAAzE,KAAf;AACA3B,IAAAA,MAAM,CAACc,IAAP,GAAcC,GAAG,CAACD,IAAlB;AACAd,IAAAA,MAAM,CAAC4B,GAAP,GAAab,GAAG,CAACa,GAAjB;AACA5B,IAAAA,MAAM,CAAC6B,KAAP,GAAe,YAAf;AACC;AACR,CAPD;AASIrC,OAAO,CAACkB,IAAR,CAAa,eAAb,EAA8B,UAAAoB,MAAM,EAAI;AACpC,MAAIA,MAAM,CAAChB,IAAP,KAAgBd,MAAM,CAACc,IAA3B,EAAiC;AAC7B;AACA;AACAR,IAAAA,OAAO,CAACC,GAAR,CAAY,gCAAZ;AACAb,IAAAA,MAAM,CAACqC,oBAAP,CAA4BD,MAAM,CAACF,GAAnC,EAAwCV,IAAxC,CAA6C;AAAA,aAAMc,kBAAkB,EAAxB;AAAA,KAA7C,EAAyEC,4BAAzE;AAEH;AACA,CARL;AAUJ,OAAO,IAAMC,YAAY,GAAG,SAAfA,YAAe,GAAM;AAC9B,SAAO,UAAA1B,QAAQ,EAAI;AACfR,IAAAA,MAAM,CAAC6B,KAAP,GAAe,YAAf,CADe,CAEf;AACA;AACA;;AACAvB,IAAAA,OAAO,CAACC,GAAR,WAAeV,MAAf;AACAH,IAAAA,MAAM,CAACqC,oBAAP,CAA4B/B,MAAM,CAAC4B,GAAnC,EAAwCV,IAAxC,CAA6C;AAAA,aAAMc,kBAAkB,EAAxB;AAAA,KAA7C,EAAyEC,4BAAzE;AACA3B,IAAAA,OAAO,CAACC,GAAR,WAAeV,MAAf,0BAPe,CAQf;AACA;AACA;;AACAH,IAAAA,MAAM,CAACyC,YAAP,GAAsBjB,IAAtB,CAA2BkB,qBAA3B,EAAkDC,+BAAlD;AACAC,IAAAA,QAAQ,GAAGpB,IAAX,CAAgBqB,SAAhB,EACCC,KADD,CACO,UAAAC,CAAC;AAAA,aAAIC,KAAK,iCAA0BD,CAAC,CAACE,IAA5B,EAAT;AAAA,KADR;AAEAnC,IAAAA,QAAQ,CAAC;AAACgB,MAAAA,IAAI,EAAEnC,WAAW,CAACuD;AAAnB,KAAD,CAAR;AACApC,IAAAA,QAAQ,CAAC;AAACgB,MAAAA,IAAI,EAAEnC,WAAW,CAACwD;AAAnB,KAAD,CAAR;AACH,GAhBD;AAiBH,CAlBM;;AAoBP,IAAMT,qBAAqB,GAAG,SAAxBA,qBAAwB,CAAAU,IAAI,EAAI;AAClCxC,EAAAA,OAAO,CAACC,GAAR,uBAA2BV,MAA3B,gBAAuCiD,IAAI,CAAClB,GAA5C;AACAtB,EAAAA,OAAO,CAACC,GAAR,WAAeV,MAAf;AACAH,EAAAA,MAAM,CAACqD,mBAAP,CAA2BD,IAA3B,EAAiC5B,IAAjC,CAAsC;AAAA,WAAM8B,iBAAiB,EAAvB;AAAA,GAAtC,EAAiEf,4BAAjE;AAEAzC,EAAAA,OAAO,CAACyD,OAAR,CAAgB,eAAhB,EAAiC;AAC7BrB,IAAAA,GAAG,EAAEkB,IADwB;AAE7BhC,IAAAA,IAAI,EAAEd,MAAM,CAACc;AAFgB,GAAjC;AAIH,CATD;;AAWA,SAASkC,iBAAT,GAA6B;AACzB1C,EAAAA,OAAO,CAACC,GAAR,WAAeV,MAAf;AACD;;AAED,SAASmC,kBAAT,GAA8B;AAC5B1B,EAAAA,OAAO,CAACC,GAAR,WAAeV,MAAf;AACD;;AACD,SAASwC,+BAAT,CAAyCf,KAAzC,EAAgD;AAC9ChB,EAAAA,OAAO,CAACC,GAAR,iDAAqDe,KAAK,CAACC,QAAN,EAArD;AACD;;AACD,SAASU,4BAAT,CAAsCX,KAAtC,EAA6C;AAC3ChB,EAAAA,OAAO,CAACC,GAAR,8CAAkDe,KAAK,CAACC,QAAN,EAAlD;AACD;;AACH,OAAO,IAAM2B,YAAY,GAAG,SAAfA,YAAe,GAAM;AAC9B,SAAO,UAAA1C,QAAQ,EAAI;AACfhB,IAAAA,OAAO,CAACyD,OAAR,CAAgB,eAAhB,EAAiC;AAAEnC,MAAAA,IAAI,EAAEd,MAAM,CAACc,IAAf;AAAqBqC,MAAAA,QAAQ,EAAEtD;AAA/B,KAAjC;AACAW,IAAAA,QAAQ,CAAC;AAACgB,MAAAA,IAAI,EAAEnC,WAAW,CAAC+D;AAAnB,KAAD,CAAR;AACH,GAHD;AAIH,CALM;;AAMP,IAAMC,aAAa,GAAG,SAAhBA,aAAgB,CAAAC,MAAM,EAAI;AAC5B,SAAO;AACH9B,IAAAA,IAAI,EAAEnC,WAAW,CAACkE,eADf;AAEHD,IAAAA,MAAM,EAAEA;AAFL,GAAP;AAIH,CALD,C,CAMA;;;AACA,OAAO,IAAME,QAAQ,GAAG,SAAXA,QAAW,CAACC,IAAD,EAAOjC,IAAP,EAAgB;AACpCxB,EAAAA,MAAM,CAACc,IAAP,GAAc2C,IAAd;AACAzD,EAAAA,MAAM,CAAC0B,QAAP,GAAkBF,IAAlB;AACAxB,EAAAA,MAAM,CAAC6B,KAAP,GAAe,UAAf;AACA7B,EAAAA,MAAM,CAAC0D,SAAP,GAAmB,IAAnB;AACApD,EAAAA,OAAO,CAACC,GAAR,CAAY,yBAAZ;AACA,SAAO,UAAAC,QAAQ,EAAI;AACf;AACA8B,IAAAA,QAAQ,GAAGpB,IAAX,CAAgBqB,SAAhB,EACCC,KADD,CACO,UAAAC,CAAC;AAAA,aAAIC,KAAK,iCAA0BD,CAAC,CAACE,IAA5B,EAAT;AAAA,KADR;AAEAnC,IAAAA,QAAQ,CAAC;AAACgB,MAAAA,IAAI,EAAEnC,WAAW,CAACuD;AAAnB,KAAD,CAAR;AAEA,QAAIe,YAAY,GAAG;AAACC,MAAAA,mBAAmB,EAAE,IAAtB;AAA4BC,MAAAA,mBAAmB,EAAE;AAAjD,KAAnB;AACAnE,IAAAA,MAAM,CAACoE,WAAP,CAAmBH,YAAnB,EAAiCzC,IAAjC,CAAsC6C,oBAAtC,EAA4D1B,+BAA5D;AACH,GARD;AASD,CAfI;;AAgBP,IAAO0B,oBAAoB,GAAG,SAAvBA,oBAAuB,CAAAjB,IAAI,EAAK;AACnCxC,EAAAA,OAAO,CAACC,GAAR,sBAA0BV,MAA1B,eAAqCiD,IAAI,CAAClB,GAA1C;AACAtB,EAAAA,OAAO,CAACC,GAAR,WAAeV,MAAf;AACAH,EAAAA,MAAM,CAACqD,mBAAP,CAA2BD,IAA3B,EAAiC5B,IAAjC,CAAsC;AAAA,WAAM8B,iBAAiB,EAAvB;AAAA,GAAtC,EAAiEf,4BAAjE;AACAzC,EAAAA,OAAO,CAACyD,OAAR,CAAgB,YAAhB,EAA8B;AAC1BrB,IAAAA,GAAG,EAAEkB,IADqB;AAE1BhC,IAAAA,IAAI,EAAEd,MAAM,CAACc,IAFa;AAG1Ba,IAAAA,IAAI,EAAE9B,MAHoB;AAI1B6B,IAAAA,QAAQ,EAAE1B,MAAM,CAAC0B;AAJS,GAA9B;AAMH,CAVD;;AAYA,IAAMa,SAAS,GAAG,SAAZA,SAAY,CAAAe,MAAM,EAAI;AACxBhD,EAAAA,OAAO,CAACC,GAAR,CAAY,uBAAZ;AACAjB,EAAAA,KAAK,CAACkB,QAAN,CAAe6C,aAAa,CAACC,MAAD,CAA5B;AACIA,EAAAA,MAAM,CAACU,SAAP,GAAmBC,OAAnB,CAA2B,UAAAC,KAAK,EAAI;AAChCxE,IAAAA,MAAM,CAACyE,QAAP,CAAgBD,KAAhB,EAAuBZ,MAAvB;AACH,GAFD;AAGP,CAND;;AAOA,IAAMc,MAAM,GAAG,SAATA,MAAS,GAAM;AACjB;AACA9B,EAAAA,QAAQ,GAAGpB,IAAX,CAAgB,UAAAoC,MAAM,EAAI;AACtBhE,IAAAA,KAAK,CAACkB,QAAN,CAAe6C,aAAa,CAACC,MAAD,CAA5B;AACAA,IAAAA,MAAM,CAACU,SAAP,GAAmBC,OAAnB,CAA2B,UAAAC,KAAK,EAAI;AAChCxE,MAAAA,MAAM,CAACyE,QAAP,CAAgBD,KAAhB,EAAuBZ,MAAvB;AACH,KAFD;;AAGI,QAAItD,MAAM,CAAC6B,KAAP,KAAiB,UAArB,EAAgC;AAC5BiC,MAAAA,WAAW;AACd,KAFD,MAEO;AACX;AACA;AACA3B,MAAAA,YAAY;AACZnC,MAAAA,MAAM,CAAC6B,KAAP,GAAe,IAAf;AACK;AACJ,GAbL,EAcKW,KAdL,CAcW,UAAAlB,KAAK,EAAI;AACdhB,IAAAA,OAAO,CAACC,GAAR,CAAY,kBAAZ,EAAgCe,KAAhC;AACD,GAhBL;AAiBH,CAnBD;;AAqBA,IAAMgB,QAAQ,GAAG,SAAXA,QAAW,GAAM;AACnB,SAAO+B,SAAS,CAACC,YAAV,CAAuBC,YAAvB,CAAoC;AACvCC,IAAAA,KAAK,EAAExE,MAAM,CAAC0B,QAAP,KAAoB,OAApB,GAA8B;AAAC+C,MAAAA,KAAK,EAAE,IAAR;AACjCC,MAAAA,MAAM,EAAE,GADyB;AAEjCC,MAAAA,SAAS,EAAE;AAFsB,KAA9B,GAEa,KAHmB;AAIvCC,IAAAA,KAAK,EAAE;AAJgC,GAApC,CAAP;AAMH,CAPD;;AAQA,IAAMC,aAAa,GAAG,SAAhBA,aAAgB,CAAArF,OAAO,EAAI;AAC7B,SAAO;AACHgC,IAAAA,IAAI,EAAEnC,WAAW,CAACyF,cADf;AAEHtF,IAAAA,OAAO,EAAEA;AAFN,GAAP;AAIH,CALD;;AAOA,OAAO,IAAMuF,cAAc,GAAG,SAAjBA,cAAiB,GAAM;AAChC,SAAO,UAAAvE,QAAQ,EAAI;AAClBA,IAAAA,QAAQ,CAACqE,aAAa,CAACrF,OAAD,CAAd,CAAR,CADkB,CAEnB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACC,GArBD;AAsBH,CAvBM;;AAwBP,IAAMiB,OAAO,GAAG,SAAVA,OAAU,CAAAyD,KAAK,EAAI;AACrB,SAAO;AACH1C,IAAAA,IAAI,EAAEnC,WAAW,CAAC2F,QADf;AAEHC,IAAAA,YAAY,EAAEf,KAAK,CAACgB,OAAN,CAAc,CAAd;AAFX,GAAP;AAIH,CALD;;AAMA,IAAMjE,eAAe,GAAG,SAAlBA,eAAkB,CAAAkE,YAAY,EAAI;AACpCzF,EAAAA,MAAM,CAACuB,eAAP,CAAuBkE,YAAvB;AACH,CAFD;;AAIA,IAAM/E,cAAc,GAAG,SAAjBA,cAAiB,CAACgF,IAAD,EAAOlF,GAAP,EAAe;AAClC,MAAIA,GAAG,CAACC,SAAR,EAAmB;AACjBX,IAAAA,OAAO,CAACyD,OAAR,CAAgB,kBAAhB,EAAoC;AAClC9C,MAAAA,SAAS,EAAED,GAAG,CAACC,SADmB;AAElCW,MAAAA,IAAI,EAAEd,MAAM,CAACc;AAFqB,KAApC;AAID;AACF,CAPH;;AAUA,IAAMiC,mBAAmB,GAAG,SAAtBA,mBAAsB,CAAAsC,WAAW,EAAI;AACvC,SAAO3F,MAAM,CAACqD,mBAAP,CAA2BsC,WAA3B,CAAP;AACH,CAFD;;AAIA,IAAMtD,oBAAoB,GAAG,SAAvBA,oBAAuB,CAAAsD,WAAW,EAAI;AACxC,SAAO3F,MAAM,CAACqC,oBAAP,CAA4BsD,WAA5B,CAAP;AACH,CAFD;;AAIA,IAAMlB,QAAQ,GAAG,SAAXA,QAAW,CAACD,KAAD,EAAQZ,MAAR,EAAmB;AAClC5D,EAAAA,MAAM,CAACyE,QAAP,CAAgBD,KAAhB,EAAuBZ,MAAvB;AACD,CAFD;;AAIA,IAAMnB,YAAY,GAAG,SAAfA,YAAe,GAAM;AACvB;AACAzC,EAAAA,MAAM,CAACyC,YAAP,GAAsBjB,IAAtB,CAA2B,UAAAU,GAAG,EAAI;AAC9B,QAAIyD,WAAW,GAAG,IAAIC,qBAAJ,CAA0B1D,GAA1B,CAAlB;AACAmB,IAAAA,mBAAmB,CAACsC,WAAD,CAAnB;AACA7F,IAAAA,OAAO,CAACyD,OAAR,CAAgB,eAAhB,EAAiC;AAC7BrB,MAAAA,GAAG,EAAEA,GADwB;AAE7Bd,MAAAA,IAAI,EAAEd,MAAM,CAACc;AAFgB,KAAjC;AAIAR,IAAAA,OAAO,CAACC,GAAR,CAAYb,MAAM,CAAC6F,cAAnB;AACH,GARD;AAQG;AACN,CAXD;;AAaA,IAAMzB,WAAW,GAAG,SAAdA,WAAc,GAAM;AACtB;AACApE,EAAAA,MAAM,CAACoE,WAAP,CAAmB;AAACF,IAAAA,mBAAmB,EAAE,IAAtB;AAA4BC,IAAAA,mBAAmB,EAAE;AAAjD,GAAnB,EAA2E3C,IAA3E,CAAgF,UAAA4B,IAAI,EAAI;AACpF,QAAIuC,WAAW,GAAG,IAAIC,qBAAJ,CAA0BxC,IAA1B,CAAlB;AACAC,IAAAA,mBAAmB,CAACsC,WAAD,CAAnB,CAFoF,CAGpF;AACA;;AACA7F,IAAAA,OAAO,CAACyD,OAAR,CAAgB,YAAhB,EAA8B;AAC1BrB,MAAAA,GAAG,EAAEkB,IADqB;AAE1BhC,MAAAA,IAAI,EAAEd,MAAM,CAACc,IAFa;AAG1Ba,MAAAA,IAAI,EAAE9B,MAHoB;AAI1B6B,MAAAA,QAAQ,EAAE1B,MAAM,CAAC0B;AAJS,KAA9B;AAMApB,IAAAA,OAAO,CAACC,GAAR,CAAYb,MAAM,CAAC6F,cAAnB;AACH,GAZD,EAaC/C,KAbD,CAaO,UAAApB,GAAG;AAAA,WAAId,OAAO,CAACC,GAAR,CAAYa,GAAZ,CAAJ;AAAA,GAbV;AAcH,CAhBD;;AAiBA,OAAO,IAAMoE,OAAO,GAAG,SAAVA,OAAU,GAAM;AACzB,SAAO,UAAAhF,QAAQ,EAAI;AACfA,IAAAA,QAAQ,CAAC;AAACgB,MAAAA,IAAI,EAAEnC,WAAW,CAACoG;AAAnB,KAAD,CAAR;AACH,GAFD;AAIH,CALM,C,CAOP;AACA;AACA","sourcesContent":["import pusher from '../../../pusherConfig';\nimport * as actionTypes from '../actions';\nimport { store }  from '../../../index';\n\nconst servers = null;\nconst channel = pusher.subscribe('presence-videocall');\nconst caller = new window.RTCPeerConnection(servers);\nconst userId = localStorage.getItem('userId');\n\nconst config = {}\n\ncaller.onicecandidate = evt => {\n    if (!evt.candidate) return;\n    // alert('candidate')\n    onIceCandidate(caller, evt);\n  };\n  caller.ontrack = evt => {\n    console.log(`${userId} received remote stream`);\n    store.dispatch(onTrack(evt));\n};\n\n//setInterval(()=> console.log(caller.signalingState), 4000);\nchannel.bind(\"pusher:subscription_succeeded\", members => {\n     \n    //this.setState({id: this.props.channel.members.me.id, room: this.props.callTo});\n    \n  });\n\nchannel.bind(\"pusher:member_added\", member => {\n    console.log(member);\n  });\n\nchannel.bind(\"pusher:member_removed\", member => {\n    if (member.id === config.room) {\n    //   alert('call Ended');\n    }\n    \n});\nchannel.bind(\"client-candidate\", msg => {\n    if (msg.room === config.room) {\n        let candidate = new RTCIceCandidate(msg.candidate);\n        console.log(candidate);\n    //   addIceCandidate(candidate);\n      caller.addIceCandidate(candidate)\n      .then(() => onAddIceCandidateSuccess(msg.room), err => onAddIceCandidateError(msg.room, err));\n    console.log(`${msg.room} ICE candidate:\\n${msg.candidate ? msg.candidate.candidate : '(null)'}`);\n    }\n});\nfunction onAddIceCandidateSuccess() {\n    console.log(`${userId} addIceCandidate success`);\n  }\n  \n  function onAddIceCandidateError(error) {\n    console.log(`${userId} failed to add ICE Candidate: ${error.toString()}`);\n  }\nchannel.bind(\"client-sdp\", msg => {\n    if (msg.room === userId) {\n        store.dispatch({type: actionTypes.ON_INCOMING_CALL, callType: msg.callType, caller: msg.from});\n        config.room = msg.room;\n        config.sdp = msg.sdp;\n        config.state = 'answerCall';\n        }\n});\n\n    channel.bind(\"client-answer\", answer => {\n        if (answer.room === config.room) {\n            // let sessionDesc = new RTCSessionDescription(answer.sdp);\n            // setRemoteDescription(sessionDesc);\n            console.log('pc1 setRemoteDescription start');\n            caller.setRemoteDescription(answer.sdp).then(() => onSetRemoteSuccess(), onSetSessionDescriptionError);\n  \n        }\n        });\n    \nexport const callAccepted = () => {\n    return dispatch => {\n        config.state = 'answerCall';\n        // let sessionDesc = new RTCSessionDescription(config.sdp);\n        // setRemoteDescription(sessionDesc);\n        // getCam();\n        console.log(`${userId} setRemoteDescription start`);\n        caller.setRemoteDescription(config.sdp).then(() => onSetRemoteSuccess(), onSetSessionDescriptionError);\n        console.log(`${userId} createAnswer start`);\n        // Since the 'remote' side has no media stream we need\n        // to pass in the right constraints in order for it to\n        // accept the incoming offer of audio and video.\n        caller.createAnswer().then(onCreateAnswerSuccess, onCreateSessionDescriptionError);\n        getMedia().then(gotStream)\n        .catch(e => alert(`getUserMedia() error: ${e.name}`));\n        dispatch({type: actionTypes.CALL_INIT})\n        dispatch({type: actionTypes.CALL_ACCEPTED})\n    }\n}\n\nconst onCreateAnswerSuccess = desc => {\n    console.log(`Answer from ${userId}:\\n${desc.sdp}`);\n    console.log(`${userId} setLocalDescription start`);\n    caller.setLocalDescription(desc).then(() => onSetLocalSuccess(), onSetSessionDescriptionError);\n    \n    channel.trigger(\"client-answer\", {\n        sdp: desc,\n        room: config.room\n    });\n}\n\nfunction onSetLocalSuccess() {\n    console.log(`${userId} setLocalDescription complete`);\n  }\n  \n  function onSetRemoteSuccess() {\n    console.log(`${userId} setRemoteDescription complete`);\n  }\n  function onCreateSessionDescriptionError(error) {\n    console.log(`Failed to create session description: ${error.toString()}`);\n  }\n  function onSetSessionDescriptionError(error) {\n    console.log(`Failed to set session description: ${error.toString()}`);\n  }\nexport const callRejected = () => {\n    return dispatch => {\n        channel.trigger(\"client-reject\", { room: config.room, rejected: userId });\n        dispatch({type: actionTypes.CALL_REJECTED})\n    }\n}\nconst onLocalStream = stream => {\n    return {\n        type: actionTypes.ON_LOCAL_STREAM,\n        stream: stream\n    }\n}\n//Create and send offer to remote peer on button click\nexport const callUser = (user, type) => {\n    config.room = user;\n    config.callType = type;\n    config.state = 'makeCall';\n    config.initiator = true;\n    console.log('Requesting local stream');\n    return dispatch => {\n        // getCam();\n        getMedia().then(gotStream)\n        .catch(e => alert(`getUserMedia() error: ${e.name}`));\n        dispatch({type: actionTypes.CALL_INIT})\n\n        let offerOptions = {offerToReceiveVideo: true, offerToReceiveAudio: true}\n        caller.createOffer(offerOptions).then(onCreateOfferSuccess, onCreateSessionDescriptionError);\n    }\n  }  \nconst  onCreateOfferSuccess = desc =>  {\n    console.log(`Offer from ${userId}\\n${desc.sdp}`);\n    console.log(`${userId} setLocalDescription start`);\n    caller.setLocalDescription(desc).then(() => onSetLocalSuccess(), onSetSessionDescriptionError);\n    channel.trigger(\"client-sdp\", {\n        sdp: desc,\n        room: config.room,\n        from: userId,\n        callType: config.callType\n    });\n}\n  \nconst gotStream = stream => {\n    console.log('Received local stream');\n    store.dispatch(onLocalStream(stream));\n        stream.getTracks().forEach(track => {\n            caller.addTrack(track, stream)\n        });\n}\nconst getCam = () => {\n    // alert('line 86--' + room);\n    getMedia().then(stream => {\n        store.dispatch(onLocalStream(stream));\n        stream.getTracks().forEach(track => {\n            caller.addTrack(track, stream)\n        });    \n            if (config.state === 'makeCall'){\n                createOffer();\n            } else {\n        // let sessionDesc = new RTCSessionDescription(config.sdp);\n        // setRemoteDescription(sessionDesc);\n        createAnswer();\n        config.state = null;\n            }\n        })\n        .catch(error => {\n          console.log(\"an error occured\", error);\n        });\n}\n\nconst getMedia = () => {\n    return navigator.mediaDevices.getUserMedia({\n        video: config.callType === 'video' ? {width: 1280,\n            height: 720,\n            frameRate: 15}: false,\n        audio: true\n      });\n}\nconst prepareCaller = channel => {\n    return {\n        type: actionTypes.PREPARE_CALLER,\n        channel: channel\n    }\n}\n\nexport const getCallerReady = () => {\n    return dispatch => {\n     dispatch(prepareCaller(channel));\n    //Listen for ICE Candidates and send them to remote peers\n    // caller.onicecandidate = evt => {\n    //   if (!evt.candidate) return;\n    //   alert('candidate')\n    //   onIceCandidate(caller, evt);\n    // };\n    // caller.onnegotiationneeded = async () => {\n    //     try {\n    //       await caller.setLocalDescription(await createOffer());\n    //       // send the offer to the other peer\n    //       channel.emit('', {desc: pc.localDescription});\n    //     } catch (err) {\n    //       console.error(err);\n    //     }\n    //   };\n    //ontrack handler to receive remote feed and show in remoteview video element\n    // caller.ontrack = evt => {\n    //     dispatch(onTrack(evt));\n    // };\n    }\n}\nconst onTrack = track => {\n    return {\n        type: actionTypes.ON_TRACK,\n        remoteStream: track.streams[0]\n    }\n}\nconst addIceCandidate = iceCandidate => {\n    caller.addIceCandidate(iceCandidate);\n}\n\nconst onIceCandidate = (peer, evt) => {\n    if (evt.candidate) {   \n      channel.trigger(\"client-candidate\", {\n        candidate: evt.candidate,\n        room: config.room\n      });\n    }\n  }\n\n\nconst setLocalDescription = sessionDesc => {\n    return caller.setLocalDescription(sessionDesc);\n}\n\nconst setRemoteDescription = sessionDesc => {\n    return caller.setRemoteDescription(sessionDesc);\n}\n\nconst addTrack = (track, stream) => {\n  caller.addTrack(track, stream);\n}\n\nconst createAnswer = () => {\n    // alert('createAnswer room: ' + receiver);\n    caller.createAnswer().then(sdp => {\n        let sessionDesc = new RTCSessionDescription(sdp);\n        setLocalDescription(sessionDesc);\n        channel.trigger(\"client-answer\", {\n            sdp: sdp,\n            room: config.room\n        });\n        console.log(caller.signalingState);\n    });;\n}\n\nconst createOffer = () => {    \n    // alert('createOffer room--180: ' + room)    \n    caller.createOffer({offerToReceiveVideo: true, offerToReceiveAudio: true}).then(desc => {\n        let sessionDesc = new RTCSessionDescription(desc);\n        setLocalDescription(sessionDesc);\n        // console.log(config);\n        // alert('createOffer room--184: ' + config.room) \n        channel.trigger(\"client-sdp\", {\n            sdp: desc,\n            room: config.room,\n            from: userId,\n            callType: config.callType\n        });\n        console.log(caller.signalingState);\n    })\n    .catch(err => console.log(err));\n}\nexport const endCall = () => {\n    return dispatch => {\n        dispatch({type: actionTypes.END_CALL});\n    }\n    \n}\n\n// setInterval(() => {\n//     console.log(caller.signalingState);\n// }, 3000);"]},"metadata":{},"sourceType":"module"}